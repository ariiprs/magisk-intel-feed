name: Magisk watcher (release + code updates) -> Telegram

on:
  schedule:
    - cron: "0 2,10 * * *"   # tiap 30 menit (UTC)
  workflow_dispatch: {}

jobs:
  watch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (for scripts)
        uses: actions/checkout@v4

      - name: Download last state (artifact)
        uses: actions/download-artifact@v4
        with:
          name: magisk-state
          path: .
        continue-on-error: true

      - name: Ensure state file exists
        run: |
          if [ ! -f last_state.env ]; then
            echo "LAST_TAG=" > last_state.env
            echo "LAST_SHA=" >> last_state.env
          fi
          cat last_state.env

      - name: Run Magisk check (release + latest commit)
        id: check
        env:
          OWNER: topjohnwu
          REPO: Magisk
          BRANCH: master
          KEYWORDS: "zygisk|denylist|hide|sulist|shamiko|namespace|mount|zygote"
        run: |
          bash scripts/magisk_check.sh

      - name: Send Telegram alert (if changed)
        if: env.SHOULD_ALERT == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          bash scripts/telegram_send.sh

      - name: Upload state artifact
        uses: actions/upload-artifact@v4
        with:
          name: magisk-state
          path: last_state.env
          retention-days: 30